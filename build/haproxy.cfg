global
    maxconn 20000
    nbthread 2
    tune.bufsize 32768
    tune.maxrewrite 1024
    log stdout format raw local0

defaults
    mode http
    timeout connect 2s
    timeout client 10s
    timeout server 10s
    option http-keep-alive
    option tcp-smart-accept
    option tcp-smart-connect
    option forwardfor
    option redispatch
    retries 3

# Health check endpoint
frontend health
    bind *:9797
    mode http
    http-request return status 200 content-type text/plain string "OK"

# Main frontend
frontend http_front
    bind *:80
    mode http
    default_backend api_backend
    option forwardfor
    capture request header Host len 32

# API backend
backend api_backend
    mode http
    balance leastconn
    option httpchk GET /healthcheck
    http-check expect status 204
    http-reuse aggressive
    
    # Health check configuration
    default-server check inter 2s rise 2 fall 3 maxconn 1000
    
    # Backend servers
    server api-1 api-1:8080 check
    server api-2 api-2:8080 check
